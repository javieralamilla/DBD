-- SENTENCIAS SQL 

-- RANKING CARTAS MAS DESEADAS POR LOS CLIENTES (CONSULTA DEL ENUNCIADO)
SELECT 
    ROW_NUMBER() OVER (ORDER BY COUNT(lp.id_producto) DESC) AS ranking,
    p.nombre AS carta,
    p.precio,
    COUNT(lp.id_producto) AS veces_deseada,
    COUNT(DISTINCT ld.id_usuario) AS usuarios_distintos,
    p.stock AS stock_disponible
FROM producto p
INNER JOIN lista_producto lp ON p.id_producto = lp.id_producto
INNER JOIN listas_de_deseos ld ON lp.id_deseo = ld.id_deseo
WHERE p.tipo_producto = 'Carta'
GROUP BY p.id_producto, p.nombre, p.precio, p.stock
ORDER BY veces_deseada DESC, usuarios_distintos DESC;

--CONSULTAS DEL EXCEL:

-- 1. AGREGAR UN JUEGO DE MESA AL CARRITO DE COMPRAS
-- Ejemplo: Usuario ID 1 agrega el producto Catan (ID 3) con cantidad 2

INSERT INTO carrito_item (id_carrito, id_producto, cantidad, precio_unitario)
SELECT 
    c.id_carrito,
    3, -- ID del producto Catan
    2, -- cantidad
    p.precio
FROM carrito c
CROSS JOIN producto p
WHERE c.id_usuario = 1 
  AND c.estado = 'activo' 
  AND p.id_producto = 3
ON CONFLICT (id_carrito, id_producto) 
DO UPDATE SET cantidad = carrito_item.cantidad + 2;


-- . AGREGAR UNA CARTA AL CARRITO DE COMPRAS
-- Ejemplo: Usuario ID 1 agrega cartas Magic MTG (ID 1) con cantidad 3
INSERT INTO carrito_item (id_carrito, id_producto, cantidad, precio_unitario)
SELECT 
    c.id_carrito,
    1, -- ID del producto Magic MTG
    3, -- cantidad
    p.precio
FROM carrito c
CROSS JOIN producto p
WHERE c.id_usuario = 1 
  AND c.estado = 'activo' 
  AND p.id_producto = 1
ON CONFLICT (id_carrito, id_producto) 
DO UPDATE SET cantidad = carrito_item.cantidad + 3;


-- 2. ELIMINAR UN JUEGO DE MESA DEL CARRITO DE COMPRAS
-- Ejemplo: Eliminar Catan del carrito del usuario ID 1
DELETE FROM carrito_item 
WHERE id_carrito IN (
    SELECT id_carrito 
    FROM carrito 
    WHERE id_usuario = 1 AND estado = 'activo'
) AND id_producto = 3;

-- ELIMINAR UNA CARTA DEL CARRITO DE COMPRAS
-- Ejemplo: Eliminar Magic MTG del carrito del usuario ID 1
DELETE FROM carrito_item 
WHERE id_carrito IN (
    SELECT id_carrito 
    FROM carrito 
    WHERE id_usuario = 1 AND estado = 'activo'
) AND id_producto = 1;

-- 3. MOSTRAR LOS JUEGOS DE MESA/CARTAS DEL CARRITO DE COMPRAS
-- Para un usuario espec√≠fico (ejemplo: usuario ID 1)
SELECT 
    ci.id_carrito,
    p.nombre AS nombre_producto,
    p.tipo_producto,
    ci.precio_unitario,
    ci.cantidad,
    (ci.precio_unitario * ci.cantidad) AS subtotal
FROM carrito c
INNER JOIN carrito_item ci ON c.id_carrito = ci.id_carrito
INNER JOIN producto p ON ci.id_producto = p.id_producto
WHERE c.id_usuario = 1 AND c.estado = 'activo'
ORDER BY p.tipo_producto, p.nombre;

